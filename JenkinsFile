pipeline {
  agent any
  options { disableConcurrentBuilds()                         // 동시 빌드 금지
                buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '30'))
                timeout(time: 30, unit: 'MINUTES')                // 파이프라인 전체 상한
                timestamps()
           }

  environment {
      IMAGE_NAME  = '2thecore-emulator'                 // 컨테이너 이름
      DOCKER_REPO = 'yeonjin529/2thecore-emulator'       // Docker Hub 리포지토리 경로
      DEPLOY_HOST = '15.165.171.174'                     // EC2 퍼블릭 IP 또는 EIP
      PEM_PATH    = '/var/lib/jenkins/.ssh/kernel-2thecore-ec2.pem'  // Jenkins 서버에 저장된 pem 경로
      APP_PORT    = '8081'                              // 에뮬레이터 서버 포트
  }

  stages {
    stage('Build & Dockerize') {
          steps {
            withCredentials([
              usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')
            ]) {
              sh '''
                set -euo pipefail

                # 1) JAR 빌드
                chmod +x ./gradlew
                ./gradlew clean bootJar -x test

                # 2) 태그 생성 (dev-<shortsha>)
                SHORT_SHA="$(git rev-parse --short HEAD)"
                TAG="dev-${SHORT_SHA}"
                echo "TAG=${TAG}" > "$WORKSPACE/build_tag.env"

                # 3) Docker 로그인
                echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin

                # 4) 이미지 빌드
                docker build -t "${DOCKER_REPO}:${TAG}" -f Dockerfile .

                # 5) latest(dev) 태그도 함께 푸시
                docker tag "${DOCKER_REPO}:${TAG}" "${DOCKER_REPO}:dev-latest"

                # 6) 푸시
                docker push "${DOCKER_REPO}:${TAG}"
                docker push "${DOCKER_REPO}:dev-latest"
              '''
            }
          }
        }

        stage('Deploy to EC2 (single container)') {
          steps {
            withCredentials([
              file(credentialsId: '2thecore-env', variable: 'ENV_FILE'),                         // prod.env 파일
              usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')
            ]) {
              sh '''
                set -euo pipefail
                source "$WORKSPACE/build_tag.env"

                # 1) prod.env 전송
                scp -o StrictHostKeyChecking=no -i "${PEM_PATH}" "$ENV_FILE" "ubuntu@${DEPLOY_HOST}:~/prod.env"

                # 2) 원격 배포 (단일 컨테이너 run)
                ssh -o StrictHostKeyChecking=no -i "${PEM_PATH}" "ubuntu@${DEPLOY_HOST}" bash -lc "'
                  set -euo pipefail

                  # Docker 로그인 (이미지 pull 위해)
                  echo ${DOCKERHUB_TOKEN} | docker login -u ${DOCKERHUB_USER} --password-stdin

                  # 이전 컨테이너 종료/삭제(있으면)
                  if docker ps -a --format \"{{.Names}}\" | grep -q \"^${IMAGE_NAME}$\"; then
                    docker rm -f ${IMAGE_NAME} || true
                  fi

                  # 최신 이미지 풀
                  docker pull ${DOCKER_REPO}:${TAG}

                  # 단일 컨테이너 실행
                  docker run -d \
                    --name ${IMAGE_NAME} \
                    --env-file ~/prod.env \
                    -p ${APP_PORT}:${APP_PORT} \
                    --restart unless-stopped \
                    ${DOCKER_REPO}:${TAG}

                  # 헬스체크(옵션): 30초 대기 후 포트 확인
                  sleep 3
                  (docker ps --filter name=${IMAGE_NAME} --format \"table {{.Names}}\\t{{.Status}}\" && \
                   ss -lnt | grep :${APP_PORT}) || true
                '"
              '''
            }
          }
        }
      }

      post {
        always {
          echo "Pipeline finished."
        }
      }
    }