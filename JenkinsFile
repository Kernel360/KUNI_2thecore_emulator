pipeline {
  agent any

  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '30'))
    timeout(time: 30, unit: 'MINUTES')
    timestamps()
  }

  environment {
    IMAGE_NAME  = '2thecore-emulator'
    DOCKER_REPO = 'yeonjin529/2thecore-emulator'
    DEPLOY_HOST = '15.165.171.174'
    PEM_PATH    = '/var/lib/jenkins/.ssh/yeojin.pem'
    APP_PORT    = '8081'
  }

  stages {

    stage('Build & Dockerize') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')
        ]) {
          sh '''
            set -euo pipefail

            # Gradle build
            chmod +x ./gradlew
            ./gradlew --no-daemon clean bootJar -x test

            # tag: dev-<shortsha>
            SHORT_SHA="$(git rev-parse --short HEAD)"
            TAG="dev-${SHORT_SHA}"
            echo "TAG=${TAG}" > "$WORKSPACE/build_tag.env"

            # docker login / build / push
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin

            docker build -t "${DOCKER_REPO}:${TAG}" -f Dockerfile .
            docker tag  "${DOCKER_REPO}:${TAG}" "${DOCKER_REPO}:dev-latest"

            docker push "${DOCKER_REPO}:${TAG}"
            docker push "${DOCKER_REPO}:dev-latest"
          '''
        }
      }
    }

    stage('Deploy to EC2 (single container)') {
      steps {
        withCredentials([
          file(credentialsId: '2thecore-env', variable: 'ENV_FILE'),
          usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')
        ]) {
          sh '''
            set -euo pipefail
            source "$WORKSPACE/build_tag.env"

            # prod.env 없는 경우에만 업로드
            if ssh -o StrictHostKeyChecking=no -i "${PEM_PATH}" "ubuntu@${DEPLOY_HOST}" '[ -f /home/ubuntu/prod.env ]'; then
              echo "[deploy] using existing /home/ubuntu/prod.env on remote"
            else
              echo "[deploy] /home/ubuntu/prod.env not found; uploading..."
              scp -o StrictHostKeyChecking=no -i "${PEM_PATH}" "$ENV_FILE" "ubuntu@${DEPLOY_HOST}:/home/ubuntu/prod.env"
            fi

            # 원격 배포
            ssh -o StrictHostKeyChecking=no -i "${PEM_PATH}" "ubuntu@${DEPLOY_HOST}" "bash -lc '
              set -euo pipefail
              echo ${DOCKERHUB_TOKEN} | sudo docker login -u ${DOCKERHUB_USER} --password-stdin

              (sudo docker rm -f ${IMAGE_NAME} || true)
              sudo docker pull ${DOCKER_REPO}:${TAG}

              sudo docker run -d --name ${IMAGE_NAME} \
                -p ${APP_PORT}:${APP_PORT} \
                -v /home/ubuntu/prod.env:/app/prod.env:ro \
                --restart unless-stopped \
                ${DOCKER_REPO}:${TAG}
            '"
          '''
        }
      }
    }
  }

  post {
    always {
      echo "Pipeline finished."
    }
  }
}