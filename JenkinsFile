pipeline {
  agent any
  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '10', daysToKeepStr: '30'))
    timeout(time: 30, unit: 'MINUTES')
    timestamps()
  }

  environment {
    IMAGE_NAME  = '2thecore-emulator'
    DOCKER_REPO = 'yeojin529/2thecore-emulator'
    DEPLOY_HOST = '15.165.171.174'
    PEM_PATH    = '/var/lib/jenkins/.ssh/kernel-2thecore-ec2.pem'
    APP_PORT    = '8081'
  }

  stages {
    stage('Build & Dockerize') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')
        ]) {
          sh '''
            set -euo pipefail

            # 1) JAR 빌드
            chmod +x ./gradlew
            ./gradlew --no-daemon clean bootJar -x test

            # 2) 태그 생성 (dev-<shortsha>)
            SHORT_SHA="$(git rev-parse --short HEAD)"
            TAG="dev-${SHORT_SHA}"
            echo "TAG=${TAG}" > "$WORKSPACE/build_tag.env"

            # 3) Docker 로그인
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin

            # 4) 이미지 빌드/태그/푸시
            docker build -t "${DOCKER_REPO}:${TAG}" -f Dockerfile .
            docker tag "${DOCKER_REPO}:${TAG}" "${DOCKER_REPO}:dev-latest"
            docker push "${DOCKER_REPO}:${TAG}"
            docker push "${DOCKER_REPO}:dev-latest"
          '''
        }
      }
    }

    stage('Deploy to EC2 (single container)') {
      steps {
        withCredentials([
          file(credentialsId: '2thecore-env', variable: 'ENV_FILE'),
          usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')
        ]) {
          sh '''
            set -euo pipefail
            source "$WORKSPACE/build_tag.env"

            # 0) 원격 prod.env 존재 시 업로드 스킵, 없으면 /tmp로 업로드 후 안전 설치
            if ssh -o StrictHostKeyChecking=no -i "${PEM_PATH}" "ubuntu@${DEPLOY_HOST}" '[ -f /home/ubuntu/prod.env ]'; then
              echo "[deploy] using existing /home/ubuntu/prod.env on remote"
            else
              echo "[deploy] /home/ubuntu/prod.env not found; uploading..."
              scp -o StrictHostKeyChecking=no -i "${PEM_PATH}" "$ENV_FILE" "ubuntu@${DEPLOY_HOST}:/tmp/prod.env"
              ssh -o StrictHostKeyChecking=no -i "${PEM_PATH}" "ubuntu@${DEPLOY_HOST}" "sudo install -D -m 600 -o ubuntu -g ubuntu -T /tmp/prod.env /home/ubuntu/prod.env"
            fi

            # 1) 원격 배포 (sudo docker 사용, SSH quoting 정상화)
            ssh -o StrictHostKeyChecking=no -i "${PEM_PATH}" "ubuntu@${DEPLOY_HOST}" "bash -lc '
              set -euo pipefail

              echo ${DOCKERHUB_TOKEN} | sudo docker login -u ${DOCKERHUB_USER} --password-stdin

              (sudo docker rm -f ${IMAGE_NAME} || true)
              sudo docker pull ${DOCKER_REPO}:${TAG}

              sudo docker run -d --name ${IMAGE_NAME} \
                --env-file /home/ubuntu/prod.env \
                -p ${APP_PORT}:${APP_PORT} \
                --restart unless-stopped \
                ${DOCKER_REPO}:${TAG}

              sleep 3
              (sudo docker ps --filter name=${IMAGE_NAME} --format \"table {{.Names}}\\t{{.Status}}\" && ss -lnt | grep :${APP_PORT}) || true
            '"
          '''
        }
      }
    }
  }

  post {
    always { echo "Pipeline finished." }
  }
}